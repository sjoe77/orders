<%
  # Determine if this is nested (via customer) or standalone
  is_nested = defined?(@customer) && @customer.present?
  form_model = is_nested ? [@customer, address] : address
%>

<%= form_with(model: form_model, class: "needs-validation", novalidate: true, data: { controller: "modal-form", turbo_frame: is_nested ? "customer_addresses" : "_top" }) do |form| %>
  <% if address.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(address.errors.count, "error") %> prohibited this address from being saved:</h4>
      <ul class="mb-0">
        <% address.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card">
    <div class="card-body">
      <div class="row">
        <% unless is_nested %>
          <div class="col-md-6">
            <div class="mb-3">
              <%= form.label :customer_id, "Customer", class: "form-label" %>
              <%= form.collection_select :customer_id,
                  Customer.order(:company_name_nm),
                  :id, :display_name,
                  { prompt: 'Select customer' },
                  { class: "form-select", required: true } %>
              <div class="invalid-feedback">
                Please select a customer.
              </div>
            </div>
          </div>
        <% end %>

        <div class="col-md-6">
          <div class="mb-3">
            <%= form.label :address_type_nm, class: "form-label" %>
            <%= form.select :address_type_nm,
                options_for_select([
                  ['Billing', 'billing'],
                  ['Shipping', 'shipping']
                ], address.address_type_nm),
                { prompt: 'Select address type' },
                { class: "form-select", required: true } %>
            <div class="invalid-feedback">
              Please select an address type.
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="mb-3">
            <div class="form-check">
              <%= form.check_box :is_default_flag, class: "form-check-input" %>
              <%= form.label :is_default_flag, "Default Address", class: "form-check-label" %>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="mb-3">
            <%= form.label :address_line1_txt, class: "form-label" %>
            <%= form.text_field :address_line1_txt, class: "form-control", required: true %>
            <div class="invalid-feedback">
              Please provide a valid address line 1.
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="mb-3">
            <%= form.label :address_line2_txt, class: "form-label" %>
            <%= form.text_field :address_line2_txt, class: "form-control" %>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="mb-3">
            <%= form.label :city_nm, class: "form-label" %>
            <%= form.text_field :city_nm, class: "form-control", required: true %>
            <div class="invalid-feedback">
              Please provide a valid city.
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="mb-3">
            <%= form.label :state_nm, class: "form-label" %>
            <%= form.text_field :state_nm, class: "form-control", required: true %>
            <div class="invalid-feedback">
              Please provide a valid state.
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="mb-3">
            <%= form.label :postal_code_nm, class: "form-label" %>
            <%= form.text_field :postal_code_nm, class: "form-control", required: true %>
            <div class="invalid-feedback">
              Please provide a valid postal code.
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="mb-3">
            <%= form.label :country_code_nm, class: "form-label" %>
            <%= form.select :country_code_nm,
                options_for_select([
                  ['United States', 'US'],
                  ['Canada', 'CA'],
                  ['Mexico', 'MX']
                ], address.country_code_nm || 'US'),
                {},
                { class: "form-select", required: true } %>
            <div class="invalid-feedback">
              Please select a country.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-footer d-flex justify-content-between">
      <% if is_nested %>
        <%= link_to customer_addresses_path(@customer),
                    class: "btn btn-secondary",
                    data: { turbo_frame: "customer_addresses" } do %>
          <i class="bi bi-x"></i> Cancel
        <% end %>
      <% else %>
        <%= link_to addresses_path, class: "btn btn-secondary" do %>
          <i class="bi bi-arrow-left"></i> Back to Addresses
        <% end %>
      <% end %>

      <div>
        <% if is_nested %>
          <!-- For nested addresses, this will redirect back to customer edit where parent save handles the changes -->
          <%= form.submit "Save and Return to Customer", class: "btn btn-primary" %>
        <% else %>
          <!-- For standalone addresses, this saves directly -->
          <%= form.submit class: "btn btn-primary" %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<script>
// Bootstrap validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();
</script>