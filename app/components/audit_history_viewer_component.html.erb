<div class="audit-history-viewer" id="<%= component_id %>">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="mb-0">
      <i class="bi bi-clock-history me-2"></i>
      Audit History
    </h6>
    <span class="badge bg-secondary">
      <%= audit_entries.count %> <%= audit_entries.count == 1 ? 'entry' : 'entries' %>
    </span>
  </div>

  <% if audit_entries.any? %>
    <div class="audit-timeline">
      <% audit_entries.each_with_index do |version, index| %>
        <% event_info = format_event_type(version.event) %>
        <% entry_id = "audit_entry_#{version.id}" %>

        <div class="audit-entry border-start border-2 ps-3 pb-3 position-relative"
             style="border-color: <%= event_info[:class] == 'text-success' ? '#28a745' :
                                      event_info[:class] == 'text-primary' ? '#007bff' :
                                      event_info[:class] == 'text-danger' ? '#dc3545' : '#6c757d' %> !important;">

          <!-- Timeline dot -->
          <div class="position-absolute" style="left: -6px; top: 0;">
            <span class="badge rounded-pill p-1"
                  style="background-color: <%= event_info[:class] == 'text-success' ? '#28a745' :
                                                event_info[:class] == 'text-primary' ? '#007bff' :
                                                event_info[:class] == 'text-danger' ? '#dc3545' : '#6c757d' %>;">
              <i class="<%= event_info[:icon] %> text-white" style="font-size: 0.7rem;"></i>
            </span>
          </div>

          <!-- Entry header -->
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <span class="fw-bold <%= event_info[:class] %>">
                <i class="<%= event_info[:icon] %> me-1"></i>
                <%= event_info[:text] %>
              </span>
              <span class="text-muted ms-2">
                by <%= format_whodunnit(version) %>
              </span>
            </div>
            <small class="text-muted">
              <%= format_timestamp(version.created_at) %>
            </small>
          </div>

          <!-- Reason (if present) -->
          <% if has_reason?(version) %>
            <div class="mb-2">
              <small class="text-muted">
                <i class="bi bi-chat-left-quote me-1"></i>
                <em>"<%= format_reason(version) %>"</em>
              </small>
            </div>
          <% end %>

          <!-- Changes summary -->
          <% if show_changes? && version.event == 'update' %>
            <% changes = get_changes_summary(version) %>
            <% if changes.any? %>
              <div class="changes-summary">
                <% if collapsed_by_default? %>
                  <button class="btn btn-sm btn-outline-secondary border-0 p-0 text-decoration-none"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#<%= entry_id %>_changes"
                          aria-expanded="false"
                          aria-controls="<%= entry_id %>_changes">
                    <i class="bi bi-chevron-right me-1"></i>
                    <%= changes_count(version) %> field<%= changes_count(version) == 1 ? '' : 's' %> changed
                  </button>

                  <div class="collapse mt-2" id="<%= entry_id %>_changes">
                    <div class="changes-detail bg-light rounded p-2">
                      <% changes.each do |field, change| %>
                        <div class="row small mb-1">
                          <div class="col-3 fw-bold text-muted">
                            <%= field.humanize %>:
                          </div>
                          <div class="col-9">
                            <% if change.is_a?(Hash) && change[:from] && change[:to] %>
                              <span class="text-danger text-decoration-line-through me-2">
                                <%= change[:from] %>
                              </span>
                              →
                              <span class="text-success ms-2">
                                <%= change[:to] %>
                              </span>
                            <% else %>
                              <%= change %>
                            <% end %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% else %>
                  <div class="changes-detail bg-light rounded p-2 mt-2">
                    <% changes.each do |field, change| %>
                      <div class="row small mb-1">
                        <div class="col-3 fw-bold text-muted">
                          <%= field.humanize %>:
                        </div>
                        <div class="col-9">
                          <% if change.is_a?(Hash) && change[:from] && change[:to] %>
                            <span class="text-danger text-decoration-line-through me-2">
                              <%= change[:from] %>
                            </span>
                            →
                            <span class="text-success ms-2">
                              <%= change[:to] %>
                            </span>
                          <% else %>
                            <%= change %>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% end %>

          <!-- Reason key (for debugging/admin) -->
          <% if show_details? && reason_key(version).present? %>
            <div class="mt-2">
              <small class="text-muted font-monospace">
                Session: <%= reason_key(version) %>
              </small>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Load more (future enhancement) -->
    <% if audit_entries.count >= max_entries %>
      <div class="text-center mt-3">
        <small class="text-muted">
          <i class="bi bi-info-circle me-1"></i>
          Showing most recent <%= max_entries %> entries
        </small>
      </div>
    <% end %>
  <% else %>
    <div class="text-center text-muted py-4">
      <i class="bi bi-clock-history fs-1"></i>
      <p class="mb-0">No audit history available</p>
      <small>Changes will be tracked once they occur</small>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Toggle chevron icons when collapse toggles
  const collapseToggles = document.querySelectorAll('#<%= component_id %> [data-bs-toggle="collapse"]');

  collapseToggles.forEach(toggle => {
    const targetId = toggle.getAttribute('data-bs-target');
    const targetElement = document.querySelector(targetId);

    if (targetElement) {
      targetElement.addEventListener('show.bs.collapse', function() {
        const icon = toggle.querySelector('i.bi-chevron-right');
        if (icon) {
          icon.classList.remove('bi-chevron-right');
          icon.classList.add('bi-chevron-down');
        }
      });

      targetElement.addEventListener('hide.bs.collapse', function() {
        const icon = toggle.querySelector('i.bi-chevron-down');
        if (icon) {
          icon.classList.remove('bi-chevron-down');
          icon.classList.add('bi-chevron-right');
        }
      });
    }
  });
});
</script>