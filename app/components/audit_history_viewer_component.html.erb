<div class="audit-history-viewer h-100 d-flex flex-column"
     id="<%= component_id %>"
     data-controller="audit-history"
     data-audit-history-record-type-value="<%= record.class.name %>"
     data-audit-history-record-id-value="<%= record.id %>">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="mb-0">
      <i class="bi bi-clock-history me-2"></i>
      Audit History
    </h6>
    <small class="text-muted">
      <%= showing_entries_text %>
    </small>
  </div>

  <% if audit_entries.any? %>
    <div class="audit-timeline flex-grow-1" style="overflow-y: auto;">
      <% audit_entries.each_with_index do |transaction, index| %>
        <% entry_id = "audit_transaction_#{transaction.id}" %>

        <div class="audit-entry border-start border-3 ps-3 pb-3 position-relative"
             style="border-color: #007bff !important;">

          <!-- Timeline dot -->
          <div class="position-absolute" style="left: -7px; top: 0;">
            <span class="badge rounded-pill p-2"
                  style="background-color: #007bff;">
              <i class="bi bi-clock-history text-white" style="font-size: 0.8rem;"></i>
            </span>
          </div>

          <!-- Transaction header -->
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <span class="fw-bold text-primary">
                <i class="bi bi-box me-1"></i>
                Atomic Transaction
              </span>
              <span class="text-muted ms-2">
                by <%= transaction.user_display %>
              </span>
            </div>
            <small class="text-muted">
              <%= format_timestamp(transaction.created_at) %>
            </small>
          </div>

          <!-- Transaction reason -->
          <div class="mb-3">
            <small class="text-muted">
              <i class="bi bi-chat-left-quote me-1"></i>
              <em>"<%= transaction.reason %>"</em>
            </small>
          </div>

          <!-- Parent context -->
          <% if transaction.item %>
            <div class="mb-2">
              <small class="text-muted">
                <i class="bi bi-diagram-2 me-1"></i>
                Context: <%= transaction.item_type %> #<%= transaction.item_id %>
              </small>
            </div>
          <% end %>

          <!-- Changes in this transaction -->
          <% transaction_versions = transaction.versions.includes(:item).order(:created_at) %>
          <% if transaction_versions.any? %>
            <div class="transaction-changes">
              <% if collapsed_by_default? %>
                <button class="btn btn-sm btn-outline-secondary border-0 p-0 text-decoration-none mb-2"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#<%= entry_id %>_changes"
                        aria-expanded="false"
                        aria-controls="<%= entry_id %>_changes">
                  <i class="bi bi-chevron-right me-1"></i>
                  <%= transaction_versions.count %> change<%= transaction_versions.count == 1 ? '' : 's' %>
                  (<%= transaction.affected_models.map { |type, count| "#{count} #{type}" }.join(', ') %>)
                </button>

                <div class="collapse" id="<%= entry_id %>_changes">
                  <div class="transaction-detail bg-light rounded p-3">
                    <%= render_transaction_versions(transaction_versions) %>
                  </div>
                </div>
              <% else %>
                <div class="transaction-detail bg-light rounded p-3">
                  <%= render_transaction_versions(transaction_versions) %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Pagination controls - Always at bottom -->
    <% if total_pages > 1 %>
      <div class="d-flex justify-content-between align-items-center mt-3 pt-2 border-top" id="<%= pagination_id %>" style="flex-shrink: 0;">
        <div class="text-muted small">
          Page <%= current_page %> of <%= total_pages %>
        </div>
        <nav aria-label="Audit history pagination">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item <%= 'disabled' unless has_previous_page? %>">
              <% if has_previous_page? %>
                <a href="#" class="page-link" onclick="window.auditHistory.loadPage(<%= previous_page %>); return false;">
                  <i class="bi bi-chevron-left"></i>
                </a>
              <% else %>
                <span class="page-link">
                  <i class="bi bi-chevron-left"></i>
                </span>
              <% end %>
            </li>

            <% if current_page > 2 %>
              <li class="page-item">
                <a href="#" class="page-link" onclick="window.auditHistory.loadPage(1); return false;">1</a>
              </li>
              <% if current_page > 3 %>
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              <% end %>
            <% end %>

            <% if has_previous_page? %>
              <li class="page-item">
                <a href="#" class="page-link" onclick="window.auditHistory.loadPage(<%= previous_page %>); return false;"><%= previous_page %></a>
              </li>
            <% end %>

            <li class="page-item active">
              <span class="page-link"><%= current_page %></span>
            </li>

            <% if has_next_page? %>
              <li class="page-item">
                <a href="#" class="page-link" onclick="window.auditHistory.loadPage(<%= next_page %>); return false;"><%= next_page %></a>
              </li>
            <% end %>

            <% if current_page < total_pages - 1 %>
              <% if current_page < total_pages - 2 %>
                <li class="page-item disabled">
                  <span class="page-link">...</span>
                </li>
              <% end %>
              <li class="page-item">
                <a href="#" class="page-link" onclick="window.auditHistory.loadPage(<%= total_pages %>); return false;"><%= total_pages %></a>
              </li>
            <% end %>

            <li class="page-item <%= 'disabled' unless has_next_page? %>">
              <% if has_next_page? %>
                <a href="#" class="page-link" onclick="window.auditHistory.loadPage(<%= next_page %>); return false;">
                  <i class="bi bi-chevron-right"></i>
                </a>
              <% else %>
                <span class="page-link">
                  <i class="bi bi-chevron-right"></i>
                </span>
              <% end %>
            </li>
          </ul>
        </nav>
      </div>
    <% end %>
  <% else %>
    <div class="text-center text-muted py-4 flex-grow-1 d-flex flex-column justify-content-center">
      <i class="bi bi-clock-history fs-1"></i>
      <p class="mb-0">No audit history available</p>
      <small>Changes will be tracked once they occur</small>
    </div>
  <% end %>
</div>

<script>
window.auditHistory = {
  loadPage: function(page) {
    const modal = document.getElementById('auditHistoryModal');
    const modalBody = modal.querySelector('.modal-body');
    const recordId = '<%= record.id %>';
    const entityType = '<%= record.class.name.downcase %>';

    modalBody.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

    fetch(`/${entityType}s/${recordId}/audit_page?page=${page}`, {
      headers: {
        'Accept': 'text/html',
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
    .then(response => response.text())
    .then(html => {
      modalBody.innerHTML = html;
    })
    .catch(error => {
      console.error('Error:', error);
      modalBody.innerHTML = '<div class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle fs-1"></i><p class="mb-0">Error loading audit history</p></div>';
    });
  }
};

document.addEventListener('DOMContentLoaded', function() {
  // Toggle chevron icons when collapse toggles
  const collapseToggles = document.querySelectorAll('#<%= component_id %> [data-bs-toggle="collapse"]');

  collapseToggles.forEach(toggle => {
    const targetId = toggle.getAttribute('data-bs-target');
    const targetElement = document.querySelector(targetId);

    if (targetElement) {
      targetElement.addEventListener('show.bs.collapse', function() {
        const icon = toggle.querySelector('i.bi-chevron-right');
        if (icon) {
          icon.classList.remove('bi-chevron-right');
          icon.classList.add('bi-chevron-down');
        }
      });

      targetElement.addEventListener('hide.bs.collapse', function() {
        const icon = toggle.querySelector('i.bi-chevron-down');
        if (icon) {
          icon.classList.remove('bi-chevron-down');
          icon.classList.add('bi-chevron-right');
        }
      });
    }
  });
});
</script>